name: IR_Multi_Proxy_Shahan_Style_2026
on:
  workflow_dispatch: # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  deploy_xray:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Ø§Ø¬Ø±Ø§ ØªØ§ 6 Ø³Ø§Ø¹Øª
    
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq uuid-runtime

      - name: Install Xray Core
        run: |
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† sudo Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ø®Ø·Ø§ÛŒ Permission
          sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

      - name: Generate Configs & Run Xray
        id: vars
        run: |
          # ØªÙˆÙ„ÛŒØ¯ UUID Ùˆ Ù¾Ø³ÙˆØ±Ø¯
          MY_UUID=$(uuidgen)
          MY_PASS="shahan_pass"
          echo "uuid=$MY_UUID" >> $GITHUB_OUTPUT
          echo "pass=$MY_PASS" >> $GITHUB_OUTPUT
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          sudo mkdir -p /usr/local/etc/xray
          
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯
          sudo bash -c "cat <<EOF > /usr/local/etc/xray/config.json
          {
            "inbounds": [
              {
                "port": 8080,
                "protocol": "vless",
                "settings": {
                  "clients": [{"id": \"$MY_UUID\"}],
                  "decryption": "none"
                },
                "streamSettings": {"network": "tcp"}
              },
              {
                "port": 8081,
                "listen": "127.0.0.1",
                "protocol": "vmess",
                "settings": {"clients": [{"id": \"$MY_UUID\"}]}
              },
              {
                "port": 8082,
                "listen": "127.0.0.1",
                "protocol": "trojan",
                "settings": {"clients": [{"password": \"$MY_PASS\"}]}
              }
            ],
            "outbounds": [{"protocol": "freedom"}]
          }
          EOF"
          
          # Ø§Ø¬Ø±Ø§ÛŒ Xray Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (Ù…Ø·Ù…Ø¦Ù†â€ŒØªØ± Ø§Ø² systemd Ø¯Ø± Ø±Ø§Ù†Ø±)
          sudo nohup xray run -c /usr/local/etc/xray/config.json > /dev/null 2>&1 &
          sleep 5

      - name: Install & Start Ngrok
        id: tunnel
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          
          # Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆÙ†Ù„ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 8080
          ngrok tcp 8080 --log=stdout > ngrok.log &
          sleep 10
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ø¯Ø±Ø³ ØªÙˆÙ†Ù„
          TUNNEL_ADDR=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' | sed 's/tcp:\/\///')
          echo "addr=$TUNNEL_ADDR" >> $GITHUB_OUTPUT

      - name: Display All Configs
        run: |
          ADDR="${{ steps.tunnel.outputs.addr }}"
          UUID="${{ steps.vars.outputs.uuid }}"
          PASS="${{ steps.vars.outputs.pass }}"
          
          if [ -z "$ADDR" ] || [ "$ADDR" == "null" ]; then
            echo "âŒ Error: Ngrok tunnel failed. Check your Token."
            exit 1
          fi
          
          HOST=$(echo $ADDR | cut -d':' -f1)
          PORT=$(echo $ADDR | cut -d':' -f2)
          
          echo "=========================================================="
          echo "ğŸš€ ALL-IN-ONE CONFIGS READY"
          echo "=========================================================="
          echo ""
          echo "1ï¸âƒ£ VLESS CONFIG:"
          echo "vless://$UUID@$HOST:$PORT?encryption=none&security=none&type=tcp#Shahan_VLESS"
          echo ""
          echo "2ï¸âƒ£ TROJAN CONFIG:"
          echo "trojan://$PASS@$HOST:$PORT?security=none&type=tcp#Shahan_Trojan"
          echo ""
          echo "3ï¸âƒ£ VMESS CONFIG:"
          VMESS_JSON=$(cat <<EOF
          {
            "v": "2", "ps": "Shahan_VMess", "add": "$HOST", "port": "$PORT",
            "id": "$UUID", "aid": "0", "net": "tcp", "type": "none", "host": "", "path": "", "tls": "none"
          }
          EOF
          )
          echo "vmess://$(echo -n $VMESS_JSON | base64 -w 0)"
          echo ""
          echo "=========================================================="

      - name: Keep Runner Alive
        run: |
          echo "Server is Running... Don't close this tab!"
          sleep 21600
