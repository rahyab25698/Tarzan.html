name: IR_SSH_Shahan_Style_2026
on:
  workflow_dispatch: # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  deploy_ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Ø§Ø¬Ø±Ø§ ØªØ§ 6 Ø³Ø§Ø¹Øª [6]
    
    steps:
      - name: Setup SSH Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server sshpass 
          # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ù…Ø´Ø§Ø¨Ù‡ Ù¾Ù†Ù„ Ø´Ø§Ù‡Ø§Ù†
          sudo useradd -m -s /bin/bash shahan_user
          echo "shahan_user:pass1234" | sudo chpasswd
          sudo service ssh start

      - name: Install & Start Ngrok
        id: tunnel
        run: |
          # Ù†ØµØ¨ Ngrok Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÙ†Ù„ TCP 
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          
          # Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆÙ†Ù„ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 22 (SSH) 
          ngrok tcp 22 --log=stdout > ngrok.log &
          sleep 10
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ø¯Ø±Ø³ Ùˆ Ù¾ÙˆØ±Øª Ø§Ø² Ù„Ø§Ú¯
          TUNNEL_ADDR=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' | sed 's/tcp:\/\///')
          echo "addr=$TUNNEL_ADDR" >> $GITHUB_OUTPUT

      - name: Display Connection Info
        run: |
          ADDR="${{ steps.tunnel.outputs.addr }}"
          if [ -z "$ADDR" ] || [ "$ADDR" == "null" ]; then
            echo "âŒ Error: Could not get Ngrok tunnel address. Check your NGROK_AUTH_TOKEN."
            exit 1
          fi
          
          HOST=$(echo $ADDR | cut -d':' -f1)
          PORT=$(echo $ADDR | cut -d':' -f2)
          
          echo "------------------------------------------"
          echo "âœ… SSH VPN Ready (Shahan Style)"
          echo "ğŸ“ Host: $HOST"
          echo "ğŸ”¢ Port: $PORT"
          echo "ğŸ‘¤ User: shahan_user"
          echo "ğŸ”‘ Pass: pass1234"
          echo "------------------------------------------"
          echo "SSH Command: ssh shahan_user@$HOST -p $PORT"
          echo "------------------------------------------"

      - name: Keep Runner Alive
        run: |
          echo "SSH Server is live via Ngrok. Waiting for connections..."
          sleep 21600 # Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø±Ø§Ù†Ø± Ø¨Ø±Ø§ÛŒ 6 Ø³Ø§Ø¹Øª [6]
